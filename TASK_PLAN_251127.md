---
task_id: IMPROVE_TASK_GENERATION_AND_SUBTASKS
status: completed
date: 2025-11-27
completion_date: 2025-11-27
---

# Task: Improve Task Generation Quality and Implement Sub-tasks

## Problem Statement

1. **Shallow Descriptions**: Tasks generated by llama3.2:latest lack depth and detail. Descriptions are too brief and don't provide sufficient context for implementation.

2. **Missing Sub-tasks**: The domain model has `parent_task_id` and `subtask_ids` fields, but there's no workflow to decompose complex tasks into hierarchical sub-tasks.

## Goals

1. Enhance LLM prompts to generate more detailed, actionable task descriptions
2. Implement sub-task decomposition workflow
3. Display sub-task hierarchy in TUI
4. Ensure sub-tasks link properly to parent tasks

## Analysis

### Current State

**Task Model** (task_manager/src/domain/task.rs:33-35):
- `parent_task_id: Option<String>` - Link to parent task
- `subtask_ids: Vec<String>` - List of child tasks
- Fields exist but no workflow uses them

**PRD Parser** (task_orchestrator/src/adapters/rig_prd_parser_adapter.rs):
- Uses `build_system_prompt()` to guide LLM task generation
- Current prompt focuses on JSON format but lacks depth instructions
- No sub-task generation logic

**Task Status** (task_manager/src/domain/task_status.rs):
- `PendingDecomposition` status exists (line 23)
- `Decomposed` status exists (line 26)
- Suggests original plan included decomposition workflow

### Root Causes

**1. Shallow Descriptions**:
- System prompt doesn't emphasize detail requirements
- No examples of high-quality descriptions
- llama3.2:latest may need more explicit guidance

**2. Missing Sub-tasks**:
- No decomposition logic in task orchestration
- No UI for triggering decomposition
- No display of task hierarchy in TUI

## Plan

### Phase 1: Enhance Description Quality

- [x] 1. Update `build_system_prompt()` to include depth requirements
  - âœ“ Added DESCRIPTION REQUIREMENTS section with 4-part structure (WHAT, WHY, HOW, ACCEPTANCE)
  - âœ“ Provided concrete good/bad examples (authentication system vs. vague description)
  - âœ“ Updated both persona and non-persona prompt branches

- [x] 2. Add description quality validation
  - âœ“ Created `validate_description_quality()` function with 4-indicator scoring system
  - âœ“ Checks minimum 100-character length requirement
  - âœ“ Validates presence of technical keywords, reasoning, criteria, and multiple sentences
  - âœ“ Integrated into task parsing flow with non-blocking ValidationInfo warnings
  - âœ“ Tasks with brief descriptions still created but user is notified

- [x] 3. Test with sample PRDs
  - âœ“ Created test PRD and parsed with llama3.2:latest
  - âœ“ Verified descriptions are 230-300 characters (vs. previous empty/brief)
  - âœ“ All descriptions contain WHAT/WHY/HOW/ACCEPTANCE elements
  - âœ“ Example: "Define Technical Requirements" generated 298-char description with endpoint details, security practices, and constraints
  - âœ“ Enhanced prompt successfully guides llama3.2:latest to produce detailed, actionable descriptions

### Phase 2: Implement Sub-task Decomposition

- [x] 4. Create decomposition workflow
  - âœ“ Implemented `decompose_task()` method in RigPRDParserAdapter
  - âœ“ Created `build_decomposition_prompt()` with parent task context, PRD snippet, and persona list
  - âœ“ Created `parse_subtasks_from_json()` that sets `parent_task_id` linkage
  - âœ“ Sub-tasks maintain PRD association via `source_prd_id`
  - âœ“ Sub-tasks default to lower complexity (3 vs 5)
  - âœ“ Full JSON remediation and assignee validation support

- [x] 5. Add decomposition trigger logic
  - âœ“ Implemented auto-decomposition in parse.rs (lines 155-202)
  - âœ“ Triggers for tasks with complexity >= 7
  - âœ“ Progress feedback: "ðŸ”„ Decomposing complex task (complexity X): {title}"
  - âœ“ Creates parser with same config (model_name + fallback_model)
  - âœ“ Calls `parser.decompose_task(task, &prd_content).await`
  - âœ“ Saves all sub-tasks to database
  - âœ“ Updates parent task with subtask_ids and Decomposed status
  - âœ“ Non-fatal error handling: logs warning and continues on failure
  - âœ“ Summary stats: "âœ“ Auto-decomposed X complex tasks into Y sub-tasks"

- [x] 6. Update TUI to display hierarchy
  - âœ“ Created HierarchicalTask struct to represent tasks with depth metadata
  - âœ“ Implemented build_hierarchical_task_list() to organize tasks into parent-child relationships
  - âœ“ Created get_tree_indicator() for box-drawing tree prefixes (â”œâ”€, â””â”€)
  - âœ“ Modified all 5 Kanban columns (TODO, IN PROGRESS, COMPLETED, ARCHIVED, ERRORED)
  - âœ“ Sub-tasks appear indented beneath parent tasks with tree connectors
  - âœ“ Dynamic width calculation accounts for tree prefix and age icons
  - âœ“ Navigation works through hierarchical list (Up/Down moves between all visible items)

### Phase 3: Integration and Testing

- [x] 7. Wire decomposition into interactive TUI PRD flow
  - âœ“ Added decomposition logic to SavingTasks state in process_prd_step() (tui.rs:2222-2268)
  - âœ“ Reads config.json for model names (main + fallback)
  - âœ“ Iterates through saved tasks checking complexity >= 7
  - âœ“ Creates RigPRDParserAdapter with same config as task generation
  - âœ“ Calls decompose_task() with PRD raw_content
  - âœ“ Saves sub-tasks to database via adapter.save_async()
  - âœ“ Updates parent task with subtask_ids and Decomposed status
  - âœ“ Non-fatal error handling (warnings to stderr, doesn't block completion)
  - âœ“ ReloadingTasks state fetches all tasks including new sub-tasks
  - âœ“ Hierarchical Kanban display shows parent â†’ indented children

- [x] 8. Add comprehensive tests
  - âœ“ Test decomposition LLM prompt and parsing (test_build_decomposition_prompt_includes_parent_context, test_build_decomposition_prompt_includes_personas)
  - âœ“ Test parent/child relationship persistence (test_parse_subtasks_from_json_sets_parent_linkage)
  - âœ“ Test subtask parsing edge cases (test_parse_subtasks_uses_default_complexity, test_parse_subtasks_rejects_empty_array)
  - âœ“ Test TUI tree indicator generation (test_get_tree_indicator_returns_correct_prefixes)
  - âœ“ All 6 new tests pass successfully

- [x] 9. Update documentation
  - âœ“ Documented decomposition workflow in README.md (lines 186-237)
  - âœ“ Added hierarchy visualization example with tree indicators
  - âœ“ Explained automatic decomposition trigger (complexity >= 7)
  - âœ“ Listed task structure fields (parent_task_id, subtask_ids)
  - âœ“ Updated TUI features to mention hierarchy support (line 248)
  - âœ“ Documented benefits: actionable items, workload distribution, progress tracking

## Current Step

**Action**: COMPLETE - All Phases Finished

**Details**:
- âœ… Phase 1 (Steps 1-3): Enhanced prompts, validation, and testing COMPLETE
- âœ… Phase 2 (Steps 4-6): Decomposition workflow, auto-trigger, and TUI hierarchy COMPLETE
- âœ… Phase 3, Step 7: TUI PRD flow integration COMPLETE
- âœ… Phase 3, Step 8: Comprehensive tests COMPLETE
- âœ… Phase 3, Step 9: Documentation updates COMPLETE
- ðŸ“Š **Full Implementation Summary**:
  - **Decomposition Backend**:
    - `decompose_task()` method: âœ“ Implemented (rig_prd_parser_adapter.rs:1041-1071)
    - `build_decomposition_prompt()`: âœ“ Implemented (rig_prd_parser_adapter.rs:1078-1130)
    - `parse_subtasks_from_json()`: âœ“ Implemented (rig_prd_parser_adapter.rs:1136-1223)
    - CLI auto-decomposition: âœ“ Implemented (parse.rs:155-202)
    - TUI auto-decomposition: âœ“ Implemented (tui.rs:2222-2268)
  - **TUI Hierarchy Display**:
    - `HierarchicalTask` struct: âœ“ Created (tui.rs:7939-7946)
    - `build_hierarchical_task_list()`: âœ“ Implemented (tui.rs:7948-8056)
    - `get_tree_indicator()`: âœ“ Implemented (tui.rs:8058-8070)
    - All 5 Kanban columns updated: âœ“ TODO, IN PROGRESS, COMPLETED, ARCHIVED, ERRORED
  - Build verified: âœ“ Successful (rigger_cli compiles with warnings only)
- **What Works End-to-End**:
  - **Via CLI**: `rig parse <PRD>` decomposes complex tasks, shows summary stats
  - **Via TUI**: Interactive PRD processing silently decomposes in background
  - Complex tasks (complexity >= 7) automatically decompose into 3-5 sub-tasks
  - Sub-tasks linked to parent via `parent_task_id` and `subtask_ids`
  - Parent task status changes to `Decomposed`
  - TUI Kanban displays sub-tasks indented beneath parents with tree indicators (â”œâ”€, â””â”€)
  - Navigation works through full hierarchical list
  - Non-fatal error handling (decomposition failures don't block task save)
- **Next Steps**: Phase 3, Steps 8-9 (testing and documentation)

## Blockers

None. All phases complete.

## Open Questions

1. **Decomposition Threshold**: Should we auto-decompose at complexity >= 7, or make it user-triggered only?

2. **Decomposition Depth**: Should sub-tasks be further decomposable, or limit to 2 levels (parent â†’ children)?

3. **Description Template**: Should we enforce a specific description format (e.g., markdown sections for Context, Steps, Acceptance Criteria)?

4. **Model Selection**: Should we use the main model or fallback model for decomposition? Complex tasks might benefit from more powerful model.

## Notes

- The domain model already supports task hierarchies, so this is primarily workflow implementation
- llama3.2:latest is a smaller model - may need very explicit prompting for quality descriptions
- Consider adding description examples directly in system prompt as "few-shot" learning
- Sub-task decomposition could be exposed as a reusable port/use-case for other adapters
